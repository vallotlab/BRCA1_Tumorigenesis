---
title: "Countings_microFoci_InVivo_Orga"
author: "Melissa"
date: "9/21/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

############################## PART1: In Vivo Data ###########################
```{r}
source(knitr::purl(file.path(mainDir,"Scripts","global_var_current.Rmd"), quiet=TRUE))
source(knitr::purl(file.path(mainDir,"Scripts","scRNAseq_Functions.Rmd"), quiet=TRUE))
source(knitr::purl(file.path(mainDir,"Scripts","global_variables.Rmd"), quiet=TRUE))
```

```{r}
library(rio)
iv_list <- import_list("/Users/equipe.soumelis/Desktop/Microscopy/Bilan_Comptage_invivo.xlsx")
iv_list = lapply(iv_list, function(x) { x=rbind(x, colnames(x))} )
iv_list =lapply(iv_list, setNames, nm = c("Slice", "Count","TotArea","AvgSize","PercArea","Mean"))
```

Split the datasets:
```{r}
gland <- rbindlist(iv_list[which(names(iv_list) %in% grep("G_7060_", names(iv_list), value = T))])
gland= na.omit(gland)
##
mles <- rbindlist(iv_list[which(names(iv_list) %in% grep("mLesion_7058", names(iv_list), value = T))])
mles= na.omit(mles)
##
tum <- rbindlist(iv_list[which(names(iv_list) %in% grep("T_7071", names(iv_list), value = T))])
tum= na.omit(tum)
##
ctrl <- rbindlist(iv_list[which(names(iv_list) %in% grep("Ctrl", names(iv_list), value = T))])
ctrl =na.omit(ctrl)
```

Add a column to specify type:
```{r}
gland$type=rep("Gland", nrow(gland))
mles$type=rep("mLes", nrow(mles))
tum$type=rep("Tum", nrow(tum))
ctrl$type=rep("Ctrl", nrow(ctrl))
##
dat <- rbind(gland, mles, tum, ctrl)
dat$type = as.factor(dat$type)
dat=as.data.frame(dat)
dat$Count=as.numeric(as.character(dat$Count))
##
dat$type= factor(dat$type, levels = c("Gland","Ctrl","mLes", "Tum"))
```

c("#398A29", "#4CBD48", "#A1B345", "#BF4CA4")

```{r}
pdf(paste0(figDir, "/DotPlot_InVivo_Counting.pdf"), width = 8, height = 8)
  ggplot(dat, aes(x=type, y=Count, color= type)) +  geom_jitter( alpha=0.4, height = 0.5, size=2)  + themplot + gtheme + scale_color_manual(values=c( "black" , "black", "black" , "black")) +  stat_compare_means(data= dat,label = "p.signif", method = "wilcox.test", ref.group = "Gland",aes(label=..p.adj..)) +
stat_summary(fun.y=median, fun.ymin=function(x) median(x) - sd(x), 
               fun.ymax=function(x) median(x) + sd(x), geom="errorbar", width=0.2, color="blue") +
  stat_summary(fun.y=median, geom="line",color="blue") +
  stat_summary(fun.y=median, geom="point",color="blue")  + theme(legend.position="none") 
 dev.off()
 ###
png(paste0(figDir, "/DotPlot_InVivo_Counting.png"), width = 1000, height = 1000, res = 200)
  ggplot(dat, aes(x=type, y=Count, color= type)) +  geom_jitter( alpha=0.4, height = 0.5, size=2)  + themplot + gtheme + scale_color_manual(values=c( "black" , "black", "black" , "black")) +  stat_compare_means(data= dat,label = "p.signif", method = "wilcox.test", ref.group = "Gland",aes(label=..p.adj..)) +
stat_summary(fun.y=median, fun.ymin=function(x) median(x) - sd(x), 
               fun.ymax=function(x) median(x) + sd(x), geom="errorbar", width=0.2, color="blue") +
  stat_summary(fun.y=median, geom="line",color="blue") +
  stat_summary(fun.y=median, geom="point",color="blue")  + theme(legend.position="none") 
 dev.off()
 
```

replace NA values with 0:
```{r}
dat$TotArea = as.numeric(as.character(dat$TotArea)) #cor between the two is 0.8
dat$AvgSize= as.numeric(as.character(dat$AvgSize))
dat$PercArea=as.numeric(as.character(dat$PercArea))
dat[is.na(dat)]=0
###
pdf(paste0(figDir, "/DotPlot_InVivo_AvgSize.pdf"), width = 8, height = 8)
    ggplot(dat, aes(x=type, y=AvgSize, color= type)) + 
    geom_jitter(height=0.5, alpha=0.4) + stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="blue") + themplot + gtheme + scale_color_manual(values=c( "#12B32A" , "#0C661A", "#C483DB" , "#8B1EA1")) +  stat_compare_means(data= dat,label = "p.signif", method = "wilcox.test", ref.group = "Gland",aes(label=..p.adj..))
dev.off()
####

pdf(paste0(figDir, "/DotPlot_InVivo_TotArea.pdf"), width = 8, height = 8)
    ggplot(dat, aes(x=type, y=TotArea, color= type)) + 
    geom_jitter(height=0.5, alpha=0.4) + stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="blue") + themplot + gtheme + scale_color_manual(values=c( "#12B32A" , "#0C661A", "#C483DB" , "#8B1EA1")) +  stat_compare_means(data= dat,label = "p.signif", method = "wilcox.test", ref.group = "Gland",aes(label=..p.adj..))
dev.off()
###
pdf(paste0(figDir, "/DotPlot_InVivo_PercArea.pdf"), width = 8, height = 8)
    ggplot(dat, aes(x=type, y=PercArea, color= type)) + 
    geom_jitter(height=0.5, alpha=0.4) + stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="blue") + themplot + gtheme + scale_color_manual(values=c( "#12B32A" , "#0C661A", "#C483DB" , "#8B1EA1")) +  stat_compare_means(data= dat,label = "p.signif", method = "wilcox.test", ref.group = "Gland",aes(label=..p.adj..))
dev.off()
```

############################## PART2: Organoids ###################################################

```{r}
library(rio)
org_list <- import_list("/Users/equipe.soumelis/Desktop/Microscopy/Bilan_Comptage_organoids.xlsx")
org_list = lapply(org_list, function(x) { x=rbind(x, colnames(x))} )
org_list =lapply(org_list, setNames, nm = c("Slice", "Count","TotArea","AvgSize","PercArea","Mean"))
##
for (i in seq_len(length(org_list)))
{
    org_list[[i]]$passage= rep(str_sub(names(org_list[i]), -4,-3), nrow( org_list[[i]])) }
```

Split the datasets and create the passage column:
```{r}
gl <- rbindlist(org_list[which(names(org_list) %in% grep("G_6377", names(org_list), value = T))])
gl= na.omit(gl)
gl=as.data.frame(gl)
gl$type= rep("Ctrl", nrow(gl))
##
juxta <- rbindlist(org_list[which(names(org_list) %in% grep("J6957_", names(org_list), value = T))])
juxta= na.omit(juxta)
juxta=as.data.frame(juxta)
juxta$type= rep("Juxta", nrow(juxta))
##
otum <- rbindlist(org_list[which(names(org_list) %in% grep("T[0-9][0-9]", names(org_list), value = T))])
otum= na.omit(otum)
otum=as.data.frame(otum)
otum$type= rep("Tumor", nrow(otum))
```

```{r}
gl$Count=as.numeric(as.character(gl$Count))

pdf(paste0(figDir, "/DotPlot_Orga_GlandCtrl_Count.pdf"), width = 5, height = 10)
 ggplot(gl, aes(x=passage, y=Count, color= passage,show.legend = F)) + 
    geom_jitter(height=0.5, alpha=0.4)  + stat_summary(fun.data=mean_sdl,
                 geom="pointrange", color="blue") + themplot + gtheme  +  stat_compare_means(data= gl,label = "p.signif", method = "wilcox.test", ref.group = "p2",aes(label=..p.adj..))+ theme(legend.position="none")+  scale_y_continuous(name="Count", breaks=seq(0, 10, 5)) + coord_cartesian(ylim=c(0,10))
dev.off()
```


```{r}
juxta$Count=as.numeric(as.character(juxta$Count))

pdf(paste0(figDir, "/DotPlot_Orga_Juxta_Count.pdf"), width = 5, height = 10)
    ggplot(juxta, aes(x=passage, y=Count, color= passage)) + 
    geom_jitter(height=0.5, alpha=0.4)  + stat_summary(fun.data=mean_sdl,
                 geom="pointrange", color="blue")  +themplot + gtheme  +  stat_compare_means(data= juxta,label = "p.signif", method = "wilcox.test", ref.group = "p1",aes(label=..p.adj..))+ theme(legend.position="none") 
dev.off()
```

```{r}
otum$Count=as.numeric(as.character(otum$Count))

pdf(paste0(figDir, "/DotPlot_Orga_Tumor_Count_WithoutPooling.pdf"), width = 5, height = 10)
     ggplot(otum, aes(x=passage, y=Count, color= passage)) + 
    geom_jitter(height=0.5, alpha=0.4)  + stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="blue") + themplot + gtheme  +  stat_compare_means(data= otum,label = "p.signif", method = "wilcox.test", ref.group = "p1",aes(label=..p.adj..)) + scale_y_continuous(breaks=seq(0,10, 5)) + theme(legend.position="none") 
dev.off()

```

```{r}
otum = otum %>% dplyr::filter(! passage=="p2")
otum$pooled= otum$passage
#otum$pooled=dplyr::recode(otum$pooled, "p2"="p1", "p5"="p3")
otum$pooled=dplyr::recode(otum$pooled, "p5"="p3")
##
pdf(paste0(figDir, "/DotPlot_Orga_Tumor_Count_WO_P2.pdf"), width = 5, height = 8)
     ggplot(otum, aes(x=pooled, y=Count, color= pooled)) + 
    geom_jitter(height=0.5, alpha=0.4)  + themplot + gtheme  +  stat_compare_means(data= otum,label = "p.signif", method = "wilcox.test", ref.group = "p1",aes(label=..p.adj..)) + scale_y_continuous(breaks=seq(0,10, 5))  + theme(legend.position="none")  + stat_summary(fun.data=mean_sdl, 
                 geom="pointrange", color="blue") + coord_cartesian(ylim=c(0,10))
dev.off()
```
Approach 2: work per sample:

T6957:
```{r}
gl <- rbindlist(org_list[which(names(org_list) %in% grep("G_6377", names(org_list), value = T))])
gl= na.omit(gl)
gl=as.data.frame(gl)
gl$type= rep("Ctrl", nrow(gl))
##
juxta <- rbindlist(org_list[which(names(org_list) %in% grep("J6957_", names(org_list), value = T))])
juxta= na.omit(juxta)
juxta=as.data.frame(juxta)
juxta$type= rep("Juxta", nrow(juxta))
##
otum <- rbindlist(org_list[which(names(org_list) %in% grep("T6957", names(org_list), value = T))])
otum= na.omit(otum)
otum=as.data.frame(otum)
otum$type= rep("Tumor", nrow(otum))
```

Bind the Juxta and Tumor datasets:


```{r}
stopifnot(identical(colnames(juxta), colnames(otum)))
dat<- rbind(juxta, otum)
dat$Count= as.numeric(as.character(dat$Count))
dat$var = paste0(dat$type, "_", dat$passage)
dat$var= dplyr::recode(dat$var, "Tumor_p3"= "Tumor_p1")
```

jitter plot:
```{r}
pdf(paste0(figDir, "/DotPlot_Orga_Sample6957_JT.pdf"), width = 8, height = 5)
     ggplot(dat, aes(x=var, y=Count, color= var)) + 
    geom_jitter(height=0.5, alpha=0.5)  + themplot + gtheme  +  stat_compare_means(data= dat,label = "p.signif", method = "wilcox.test", ref.group = "Juxta_p1",aes(label=..p.adj..))  + theme(legend.position="none")  + stat_summary(fun.data=mean_sdl, 
                 geom="pointrange", color="blue") + scale_color_manual(values= c("#2B992B", "#4EC452", "#8ACC8A",  "#BF4CB5"))
   #  + scale_y_continuous(breaks=seq(0,10, 5))   + coord_cartesian(ylim=c(0,10))
dev.off()

#######
pdf(paste0(figDir, "/DotPlot_Orga_Sample6957_JT_Median.pdf"), width = 8, height = 5)
  ggplot(dat, aes(x=var, y=Count, color= var)) + 
    geom_jitter(height=0.5, alpha=0.5)  + themplot + gtheme  +  stat_compare_means(data= dat,label = "p.signif", method = "wilcox.test", ref.group = "Juxta_p1",aes(label=..p.adj..))  + theme(legend.position="none")  +
stat_summary(fun.y=median, fun.ymin=function(x) median(x) - sd(x), 
               fun.ymax=function(x) median(x) + sd(x), geom="errorbar", width=0.2, color="blue") +
  stat_summary(fun.y=median, geom="line",color="blue") +
  stat_summary(fun.y=median, geom="point",color="blue")  + scale_color_manual(values= c("#2B992B", "#4EC452", "#8ACC8A",  "#BF4CB5"))

dev.off()
```

###############################################################################################
Plot the µFoci surface area:
```{r}
foldername <- "/Users/equipe.soumelis/Desktop/Microscopy/J_6957"
ld <- list.dirs(foldername)[-c(1:2,6,9)]
sampname=gsub("/Users/equipe.soumelis/Desktop/Microscopy/J_6957/p[0-9]/C3-","", ld)

###
for (i in seq_len(length(ld))){ 
     n <- grep(".tsv", list.files(ld[i]), value=T)
    for (j in seq(length(n))){
        assign(paste0(sampname[i],"_" ,j), read.table(paste0(ld[i], "/",n[j]), header = T) )
        #assign(paste0(sampname[i],"_" ,i), rbind(read.table(paste0(ld[i], "/",n[j]), header = T) ,read.table(paste0(ld[i], "/",n[j-1]), header = T)) ) 
    }
}
```

```{r}

```

get the file names:
Juxta P1:
```{r}
fn <- ls()
j1= fn[which(fn %in% grep("J6957_p1", fn, value=T))]
jp1 <- rbindlist(mget(j1)) %>% as.data.frame()
jp1$type= rep("Juxta_P1", nrow(jp1))
```

Juxta P3
```{r}
j3= fn[which(fn %in% grep("J6957_p3", fn, value=T))]
jp3 <- rbindlist(mget(j3)) %>% as.data.frame()
jp3$type= rep("Juxta_P3", nrow(jp3))
```

Juxta P6
```{r}
j6= fn[which(fn %in% grep("J6957_p6", fn, value=T))]
jp6 <- rbindlist(mget(j6)) %>% as.data.frame()
jp6$type= rep("Juxta_P6", nrow(jp6))
```

Pool the juxta area:
```{r}
stopifnot(identical(colnames(j3), colnames(j6)))
ja <- rbind(jp1,jp3,jp6)
write.csv(ja, paste0(foldername, "/Juxta_Passages_AllMerged.csv"))
rm(jp6)
```

########## T6957 
```{r}
foldername <- "/Users/equipe.soumelis/Desktop/Microscopy/T_6957"
ld <- list.dirs(foldername)[-1]
sampname=gsub("/Users/equipe.soumelis/Desktop/Microscopy/T_6957/C3-","", ld)

###
for (i in seq_len(length(ld))){ 
     n <- grep(".tsv", list.files(ld[i]), value=T)
    for (j in seq(length(n))){
        assign(paste0(sampname[i],"_" ,j), read.table(paste0(ld[i], "/",n[j]), header = T) )
        #assign(paste0(sampname[i],"_" ,i), rbind(read.table(paste0(ld[i], "/",n[j]), header = T) ,read.table(paste0(ld[i], "/",n[j-1]), header = T)) ) 
    }
}
```

get the file names:
T P1:
```{r}
fn <- ls()
j1= fn[which(fn %in% grep("T6957_p1", fn, value=T))]
jp1 <- rbindlist(mget(j1)) %>% as.data.frame()
jp1$type= rep("Tumor_P1", nrow(jp1))
```

Juxta P3
```{r}
j3= fn[which(fn %in% grep("T6957_p3", fn, value=T))]
jp3 <- rbindlist(mget(j3)) %>% as.data.frame()
jp3$type= rep("Tumor_P3", nrow(jp3))
```


Pool the juxta area:
```{r}
stopifnot(identical(colnames(jp3), colnames(jp1)))
ta <- rbind(jp1,jp3)
write.csv(ta, paste0(foldername, "/Tumor_Passages_AllMerged.csv"))
```

Read the two files:
```{r}
foldername <- "/Users/equipe.soumelis/Desktop/Microscopy/T_6957"
tarea <- read.csv(paste0(foldername, "/Tumor_Passages_AllMerged.csv"))
#
foldername <- "/Users/equipe.soumelis/Desktop/Microscopy/J_6957"
jarea <- read.csv(paste0(foldername, "/Juxta_Passages_AllMerged.csv"))
###
stopifnot(all(colnames(tarea)== colnames(jarea)))
dat <- rbind(jarea, tarea)
dat$type = as.factor(dat$type)
dat$Area=as.numeric(as.character(dat$Area))
```

Plot jitter plot:
```{r}
dat$type= dplyr::recode(dat$type, "Tumor_P3"="Tumor_P1")

pdf(paste0(figDir, "/DotPlot_Orga_Sample6957_JT_Area.pdf"), width = 8, height = 5)
     ggplot(dat, aes(x=type, y=Area, color= type)) +  
    geom_jitter(height=0.5, alpha=0.5)  + themplot + gtheme  +  stat_compare_means(data= dat,label = "p.signif", method = "wilcox.test", ref.group = "Juxta_P1",aes(label=..p.adj..))  + theme(legend.position="none")  + stat_summary(fun.data=mean_sdl, 
                 geom="pointrange", color="blue") + scale_color_manual(values= c("#2B992B", "#4EC452", "#8ACC8A",  "#BF4CB5"))
   #  + scale_y_continuous(breaks=seq(0,10, 5))   + coord_cartesian(ylim=c(0,10))
dev.off()
```

```{r}
pdf(paste0(figDir, "/VlnPlot_Orga_Sample6957_JT_Area_Log10_Median.pdf"), width = 8, height = 5)
 ggplot(dat,aes(x=type, y=log10(Area), fill= type)) +   geom_violin( data= dat, aes(x=type, y=log10(Area), fill= type), show.legend = F) + theme(legend.position="none")  + scale_fill_manual(values= c("#2B992B", "#4EC452", "#8ACC8A",  "#BF4CB5"))+ themplot + gtheme  + stat_summary(fun = "median",geom = "crossbar", color = "blue", width= 0.2)+ theme(legend.position="none") 
 dev.off()
```

```{r}
pdf(paste0(figDir, "/VlnPlot_Orga_Sample6957_JT_Area_Mean.pdf"), width = 8, height = 5)
 ggplot(dat,aes(x=type, y=Area, fill= type)) +   geom_violin( data= dat, aes(x=type, y=Area, fill= type), show.legend = F) + theme(legend.position="none")  + scale_fill_manual(values= c("#2B992B", "#4EC452", "#8ACC8A",  "#BF4CB5"))+ themplot + gtheme  + stat_summary(fun = "mean",geom = "crossbar", color = "blue", width= 0.1)+ theme(legend.position="none") + coord_cartesian(ylim=c(0,20))
 dev.off()
```

```{r}
write.csv(dat,paste0(figDir, "/Table S4_Sample6957_Juxta_Tumor_Area.csv"))
```

########Do the same with the gland control #############

Read the two files:
```{r}
foldername <- "/Users/equipe.soumelis/Desktop/Microscopy/G_6377"
ld <- list.dirs(foldername)[-c(1:2, 6)]
sampname=gsub("/Users/equipe.soumelis/Desktop/Microscopy/G_6377/p[0-9]/C3-","", ld)

###
for (i in seq_len(length(ld))){ 
     n <- grep(".tsv", list.files(ld[i]), value=T)
    for (j in seq(length(n))){
        assign(paste0(sampname[i],"_" ,j), read.table(paste0(ld[i], "/",n[j]), header = T) )
    }
}
```


get the file names:
P2:
```{r}
fn <- ls()
j1= fn[which(fn %in% grep("G6377_p2", fn, value=T))]
jp1 <- rbindlist(mget(j1)) %>% as.data.frame()
jp1$type= rep("Gland_P2", nrow(jp1))
```

Juxta P3
```{r}
j3= fn[which(fn %in% grep("G6377_p3", fn, value=T))]
jp3 <- rbindlist(mget(j3)) %>% as.data.frame()
jp3$type= rep("Gland_P3", nrow(jp3))
```


Pool the juxta area:
```{r}
stopifnot(identical(colnames(jp3), colnames(jp1)))
ga <- rbind(jp1,jp3)
write.csv(ga, paste0(figDir, "/Gland_G6377_Passages_AllMerged_Area.csv"))
```

```{r}
pdf(paste0(figDir, "/VlnPlot_Orga_Gland_G6377_Area_Median.pdf"), width = 8, height = 5)
 ggplot(ga,aes(x=type, y=Area, fill= type)) +   geom_violin( data= ga, aes(x=type, y=Area, fill= type), show.legend = F) + theme(legend.position="none")  + scale_fill_manual(values= c( "#075404","#1D6E1A") )+ themplot + gtheme  + stat_summary(fun = "median",geom = "crossbar", color = "blue", width= 0.1)+ theme(legend.position="none") 
 dev.off()
```
