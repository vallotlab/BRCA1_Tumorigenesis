---
title: "Step6_TCGA_P16Signature_Evaluation"
author: "Melissa"
date: "05/07/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
mainDir <- here::here() # the MainDir should be the root of Tumor_BRCA_P53:
source(knitr::purl(file.path(mainDir,"Scripts","scRNAseq","mouse","TCGA","Global_Variables_TCGA.Rmd"), quiet=TRUE))

evalDir= "C:/Users/Melissa S/Desktop/BRCA1_Tumorigenesis/Tumor_BRCA_p53/output/scRNAseq/TCGA/Signature_Evaluation"
```

```{r}
tnscores=readxl::read_xlsx(paste0(RDatadir, "/Metadata_forSurvivalanalysis.xlsx"))
tn = readxl::read_xlsx( paste0(RDatadir, "/Metadata_forSurvivalanalysis_OnlyBRCA_Basal.xlsx"))
scores=readxl::read_xlsx( paste0(SIGdir, "/Signature_Scores_All_PANCANCER_p16_EMT_Apop.xlsx")) %>% as.data.frame()
rownames(scores)=scores$sample
```

```{r}
outputDir2= "C:/Users/Melissa S/Desktop/BRCA1_Tumorigenesis/Tumor_BRCA_p53/output/scRNAseq/TCGA/RData/"

tnscores=readxl::read_xlsx("C:/Users/Melissa S/Desktop/BRCA1_Tumorigenesis/Tumor_BRCA_p53/output/scRNAseq/TCGA/RData/Metadata_forSurvivalanalysis.xlsx")

tn = readxl::read_xlsx("C:/Users/Melissa S/Desktop/BRCA1_Tumorigenesis/Tumor_BRCA_p53/output/scRNAseq/TCGA/RData/Metadata_forSurvivalanalysis_OnlyBRCA_Basal.xlsx")

scores=readxl::read_xlsx( "C:/Users/Melissa S/Desktop/BRCA1_Tumorigenesis/Tumor_BRCA_p53/output/scRNAseq/TCGA/Signatures/Signature_Scores_All_PANCANCER_p16_EMT_Apop.xlsx")%>% as.data.frame()
rownames(scores)=scores$sample

genexp= qs::qread("C:/Users/Melissa S/Desktop/BRCA1_Tumorigenesis/Tumor_BRCA_p53/output/scRNAseq/TCGA/RData/Normalized_Counts_Matreix_BASALvsOthers.qs")
```


```{r}
tnscores= scores %>% dplyr::filter(rownames(scores) %in% tn$Sample.ID)
stopifnot(identical(tn$Sample.ID, rownames(tnscores)))
clin= tn
```

```{r}
seu= qs::qread("C:/Users/Melissa S/Desktop/BRCA1_Tumorigenesis/Tumor_BRCA_p53/output/scRNAseq/invivo/RData/Epithelial_FinalAnnotation.qs")
library(Seurat)
DefaultAssay(seu)="RNA"

sigN= FindMarkers(seu, ident.1 = "P16+ Pre-lesional", ident.2 = c("LP", "Avd"), only.pos = FALSE, logfc.threshold = 0.8, min.diff.pct = 0.2)  %>% tibble::rownames_to_column("gene") %>% dplyr::filter(p_val_adj < 0.05) %>% filter(avg_log2FC < 0)
##
sigP= FindMarkers(seu, ident.1 = "P16+ Pre-lesional", ident.2 = c("LP", "Avd"), only.pos = TRUE, logfc.threshold = 0.8, min.diff.pct = 0.2)  %>% tibble::rownames_to_column("gene") %>% dplyr::filter(p_val_adj < 0.05)
###
sig= FindMarkers(seu, ident.1 = "P16+ Pre-lesional", ident.2 = c("LP", "Avd"), only.pos = FALSE, logfc.threshold = 0.8, min.diff.pct = 0.2)  %>% tibble::rownames_to_column("gene") %>% dplyr::filter(p_val_adj < 0.05)
```

Heatmap representation:
```{r}
tmp <- genexp[which(rownames(genexp) %in% toupper(sigP$gene)),] %>% as.data.frame()
tmp= tmp[, which(colnames(tmp) %in% scores$sample)]

#tmp=log10(tmp)

patient_data= scores[, c( 5)] %>% as.data.frame()
rownames(patient_data)= colnames(tmp)
colnames(patient_data)="type"
patient_data$type= as.factor(patient_data$type)

p <- pheatmap::pheatmap(t(tmp), scale = "none", annotation_row  = patient_data, show_rownames = FALSE, cluster_cols = FALSE,cluster_rows = FALSE, color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
breaks = breaksList)
################

breaksList = seq(0, 100000, by = 500)

p <- pheatmap::pheatmap(tmp
                        , scale = "none", annotation_column  = patient_data, show_colnames = FALSE, cluster_cols = FALSE,cluster_rows = FALSE)
```


POSITIVE GENES :

```{r}
tmpP= data.frame("topGenes"= c(1,seq(5,nrow(sigP), 5), 39), "Best_Qtl"= NA, "Pval_Min"=NA) #,1,seq(5, nrow(sigP), 5), nrow(sigP)
rownames(tmpP)= tmpP$topGenes

for(j in c(1,seq(5,nrow(sigP), 5), 39)){
  clin=tn[,-c(100:103)]
  sigenes= sigP %>% top_n(n = abs(j), wt = abs(avg_log2FC)) 
  #sigenes$gene2= paste0(toupper(sigenes$gene), "-")
  gene.sets= list("p16"= toupper(sigenes$gene))
  dt= ScoreSignatures_UCell(genexp, features= gene.sets) %>% as.data.frame()
  dt$sample= rownames(dt)
  
 
  dt=dt %>% filter(sample %in% clin$Sample.ID)
  clin= clin %>% filter(Sample.ID %in% dt$sample)
  
  stopifnot(identical(dt$sample, clin$Sample.ID))
   
  #dt=dt[match( dt$sample,clin$Sample.ID),]
  md=cbind(clin, dt)

#############
md$Progression.Free.Status_binary <- ifelse(md$Progression.Free.Status=="0:CENSORED",0,1)
#P16Low should be tn$p16Up < quantile(tn$p16Up, 0.25)

  qtl=list("quantile"=NA, "hazard"=NA, "waldtest"=NA,"logTestPval"=NA,"waldtestPval"=NA)

for(i in seq(0.1, 0.9, 0.01)){
  md$p16discrete= ifelse(md$p16_UCell > quantile(md$p16_UCell, i), 1, 0)
   res.cox <- summary(coxph(Surv(Disease.Free..Months.,Progression.Free.Status_binary ) ~ p16discrete, data = md))
   
  qtl$quantile= append(qtl$quantile, i)
  qtl$hazard=append(qtl$hazard,res.cox$coefficients[,2])
  ##
 qtl$logTestPval= append(qtl$logTestPval, res.cox$logtest[3])
  qtl$waldtest= append(qtl$waldtest,res.cox$waldtest[1] )
   qtl$waldtestPval= append(qtl$waldtestPval,res.cox$waldtest[3] )
} 
 dt.qtl_binary= do.call(rbind, qtl) %>% t() %>%  as.data.frame()
dt.qtl_binary=dt.qtl_binary[-1,]


bestqtl=  dt.qtl_binary[order( dt.qtl_binary$logTestPval, decreasing = FALSE),1][1]
bestpval=  dt.qtl_binary[order( dt.qtl_binary$logTestPval, decreasing = FALSE),4][1]

tmpP[j,2]= bestqtl
tmpP[j,3]=bestpval
####
md$p16discrete= ifelse(md$p16_UCell > quantile(md$p16_UCell, bestqtl), "high", "low" )

fit <- survfit(Surv(Disease.Free..Months.,Progression.Free.Status_binary) ~ p16discrete, data = md)
library(survminer)
pdf(paste0(evalDir,"/SurvivalPlot_PANCANCER_PFS_", "TopPositiveFC_",j,"_BestQtl_", bestqtl,".pdf"), height = 5, width = 5)
 p=ggsurvplot(fit,
          pval = TRUE, conf.int = FALSE,
          risk.table = FALSE, 
          risk.table.col = "strata",
          linetype = "strata", 
          surv.median.line = "hv", 
          ylab="Overall surrival",
          ggtheme = theme_bw(), 
          palette = c("#DED5D5", "#262424", "#756F6F")) 
 print(p)
dev.off()

}


tmpP2=tmpP
tmpP= tmpP[c(1,seq(5,nrow(sigP), 5), 39),]
tmpP$topGenes=c(1,seq(5,nrow(sigP), 5), 39)
###
writexl::write_xlsx(tmpP, paste0(evalDir, "/PANCER_TopPositiveGenes_BestParams.xlsx"))

#####################

pdf(paste0(evalDir, "/Lines_PANCANCER_BestParams_TopPositivGenes.pdf"))

m <- tmpP %>% ggplot(aes(x= topGenes, y= Pval_Min)) + geom_point() + geom_line() + themplot + xlab("Top_Positive")

n <- tmpP %>% ggplot(aes(x= topGenes, y= Best_Qtl)) + geom_point() + geom_line() + themplot + xlab("Top_Positive")

print(m)
print(n)
dev.off()
```

NEGATIVE GENES:
```{r}
tmpN= data.frame("topGenes"= c(1,seq(5,nrow(sigN), 5), 74), "Best_Qtl"= NA, "Pval_Min"=NA) #,1,seq(5, nrow(sigP), 5), nrow(sigP)
rownames(tmpN)= tmpN$topGenes
########################################

for(j in c(1,seq(5,nrow(sigN), 5), 74)){
  clin=tn[,-c(100:103)]
   sigenes= sigN %>% top_n(n = abs(j), wt = abs(avg_log2FC)) 
  #sigenes$gene2= paste0(toupper(sigenes$gene), "-")
  gene.sets= list("p16"= paste0(toupper(sigenes$gene)))
  dt= ScoreSignatures_UCell(genexp, features= gene.sets) %>% as.data.frame()
  dt$sample= rownames(dt)
  
 
  dt=dt %>% filter(sample %in% clin$Sample.ID)
  clin= clin %>% filter(Sample.ID %in% dt$sample)
  
  stopifnot(identical(dt$sample, clin$Sample.ID))
   
  #dt=dt[match( dt$sample,clin$Sample.ID),]
  md=cbind(clin, dt)

#############
md$Progression.Free.Status_binary <- ifelse(md$Progression.Free.Status=="0:CENSORED",0,1)
#P16Low should be tn$p16Up < quantile(tn$p16Up, 0.25)

  qtl=list("quantile"=NA, "hazard"=NA, "waldtest"=NA,"logTestPval"=NA,"waldtestPval"=NA)

for(i in seq(0.1, 0.9, 0.01)){
  md$p16discrete= ifelse(md$p16_UCell > quantile(md$p16_UCell, i), 1, 0)
   res.cox <- summary(coxph(Surv(Disease.Free..Months.,Progression.Free.Status_binary ) ~ p16discrete, data = md))
   
  qtl$quantile= append(qtl$quantile, i)
  qtl$hazard=append(qtl$hazard,res.cox$coefficients[,2])
  ##
 qtl$logTestPval= append(qtl$logTestPval, res.cox$logtest[3])
  qtl$waldtest= append(qtl$waldtest,res.cox$waldtest[1] )
   qtl$waldtestPval= append(qtl$waldtestPval,res.cox$waldtest[3] )
} 
 dt.qtl_binary= do.call(rbind, qtl) %>% t() %>%  as.data.frame()
dt.qtl_binary=dt.qtl_binary[-1,]


bestqtl=  dt.qtl_binary[order( dt.qtl_binary$logTestPval, decreasing = FALSE),1][1]
bestpval=  dt.qtl_binary[order( dt.qtl_binary$logTestPval, decreasing = FALSE),4][1]

tmpN[j,2]= bestqtl
tmpN[j,3]=bestpval
####
md$p16discrete= ifelse(md$p16_UCell > quantile(md$p16_UCell, bestqtl), "high", "low" )

fit <- survfit(Surv(Disease.Free..Months.,Progression.Free.Status_binary) ~ p16discrete, data = md)
library(survminer)
pdf(paste0(evalDir,"/SurvivalPlot_PANCANCER_PFS_", "TopNegativeFC_",j,"_BestQtl_", bestqtl,".pdf"), height = 5, width = 5)
 p=ggsurvplot(fit,
          pval = TRUE, conf.int = FALSE,
          risk.table = FALSE, 
          risk.table.col = "strata",
          linetype = "strata", 
          surv.median.line = "hv", 
          ylab="Overall surrival",
          ggtheme = theme_bw(), 
          palette = c("#DED5D5", "#262424", "#756F6F")) 
 print(p)
dev.off()

}


tmpN2=tmpN
tmpN= tmpN[c(1,seq(5,nrow(sigN), 5), 74),]
tmpN$topGenes=c(1,seq(5,nrow(sigN), 5), 74)
###
writexl::write_xlsx(tmpN, paste0(evalDir, "/PANCER_TopNegativeGenes_BestParams.xlsx"))
tmpN <- readxl::read_xlsx(paste0(evalDir, "/TopNegative_Genes/PANCER_TopNegativeGenes_BestParams.xlsx"))
#####################

pdf(paste0(evalDir, "/Lines_PANCANCER_BestParams_TopNegativeGenes.pdf"))

m <- tmpN %>% ggplot(aes(x= topGenes, y= Pval_Min)) + geom_point() + geom_line() + themplot + xlab("Top_Negative")

n <- tmpN %>% ggplot(aes(x= topGenes, y= Best_Qtl)) + geom_point() + geom_line() + themplot + xlab("Top_Negative")

print(m)
print(n)
dev.off()
```


MIX TOP POSITIVE WTH TOP NEGATIVE:
```{r}
tmpB= data.frame("topGenes"= c(1,seq(5, nrow(sigP), 5), nrow(sigP)), "Best_Qtl"= NA, "Pval_Min"=NA) 
rownames(tmpB)= tmpB$topGenes

j=0
for(j in c(1,seq(5, nrow(sigP), 5), nrow(sigP))){
  
  cN= sigN %>% top_n(n = j, wt = abs(avg_log2FC)) 
  cN$gene2= paste0(toupper(cN$gene), "-")
  ##
  cP= sigP %>% top_n(n = j, wt = avg_log2FC) 
  cP$gene2= paste0(toupper(cP$gene), "+")
  ##
  
  gene.sets= list("p16"= c(cP$gene2, cN$gene2))
  
   dt= ScoreSignatures_UCell(genexp, features= gene.sets) %>% as.data.frame()
  dt$sample= rownames(dt)
  
 
  dt=dt %>% filter(sample %in% clin$Sample.ID)
  clin= clin %>% filter(Sample.ID %in% dt$sample)
  
  stopifnot(identical(dt$sample, clin$Sample.ID))
   
  #dt=dt[match( dt$sample,clin$Sample.ID),]
  md=cbind(clin, dt)

#############
md$Progression.Free.Status_binary <- ifelse(md$Progression.Free.Status=="0:CENSORED",0,1)
#P16Low should be tn$p16Up < quantile(tn$p16Up, 0.25)

  qtl=list("quantile"=NA, "hazard"=NA, "waldtest"=NA,"logTestPval"=NA,"waldtestPval"=NA)

for(i in seq(0.1, 0.9, 0.01)){
  md$p16discrete= ifelse(md$p16_UCell > quantile(md$p16_UCell, i), 1, 0)
   res.cox <- summary(coxph(Surv(Disease.Free..Months.,Progression.Free.Status_binary ) ~ p16discrete, data = md))
   
  qtl$quantile= append(qtl$quantile, i)
  qtl$hazard=append(qtl$hazard,res.cox$coefficients[,2])
  ##
 qtl$logTestPval= append(qtl$logTestPval, res.cox$logtest[3])
  qtl$waldtest= append(qtl$waldtest,res.cox$waldtest[1] )
   qtl$waldtestPval= append(qtl$waldtestPval,res.cox$waldtest[3] )
} 
 dt.qtl_binary= do.call(rbind, qtl) %>% t() %>%  as.data.frame()
dt.qtl_binary=dt.qtl_binary[-1,]


bestqtl=  dt.qtl_binary[order( dt.qtl_binary$logTestPval, decreasing = FALSE),1][1]
bestpval=  dt.qtl_binary[order( dt.qtl_binary$logTestPval, decreasing = FALSE),4][1]

tmpB[j,2]= bestqtl
tmpB[j,3]=bestpval
####
md$p16discrete= ifelse(md$p16_UCell > quantile(md$p16_UCell, bestqtl), "high", "low" )

fit <- survfit(Surv(Disease.Free..Months.,Progression.Free.Status_binary) ~ p16discrete, data = md)
library(survminer)
pdf(paste0(evalDir,"/SurvivalPlot_PANCANCER_PFS_", "TopPositive_NegativeFC_",j,"_BestQtl_", bestqtl,".pdf"), height = 5, width = 5)
 p=ggsurvplot(fit,
          pval = TRUE, conf.int = FALSE,
          risk.table = FALSE, 
          risk.table.col = "strata",
          linetype = "strata", 
          surv.median.line = "hv", 
          ylab="Overall surrival",
          ggtheme = theme_bw(), 
          palette = c("#DED5D5", "#262424", "#756F6F")) 
 print(p)
dev.off()

}

tmpB2=tmpB

tmpB=tmpB[ c(1,seq(5, nrow(sigP), 5), nrow(sigP)),]
tmpB$topGenes= c(1,seq(5, nrow(sigP), 5), nrow(sigP))

 writexl::write_xlsx(tmpB, paste0(evalDir, "/Table_PosNegTop_BestParams.xlsx"))

#####################

pdf(paste0(evalDir, "/Lines_BestParams_TopNegGenes.pdf"))

m <- tmpB %>% ggplot(aes(x= topGenes, y= Pval_Min)) + geom_point() + geom_line() + themplot + xlab("Combination_Top_Positive_Negative")

n <- tmpB %>% ggplot(aes(x= topGenes, y= Best_Qtl)) + geom_point() + geom_line() + themplot + xlab("Combination_Top_Positive_Negative")

print(m)
print(n)
dev.off()
```

COMPILE ALL the dtasets:

```{r}
tmpB$type="Both_Pos_Neg"
tmpN$type="Top_Negative"
tmpP$type="Top_Positive"

dt= rbind(tmpP, tmpN, tmpB)
 writexl::write_xlsx(dt, paste0(evalDir, "/TCGA_GeneSelection_PANCANCER.xlsx")) 
dt <- readxl::read_excel(paste0(evalDir, "/TCGA_GeneSelection_PANCANCER.xlsx"))  


pdf(paste0(evalDir, "/Lines_BestParams_All.pdf"))

m <- dt %>% ggplot(aes(x= topGenes, y= Pval_Min, color=type)) + geom_point() + geom_line() + themplot + xlab("Gene_Rank_perFC")

n <- dt %>% ggplot(aes(x= topGenes, y= Best_Qtl, color=type)) + geom_point() + geom_line() + themplot + xlab("Gene_Rank_perFC")

print(m)
print(n)
dev.off()
```




Create a dot plot:
```{r}
library(viridis)
dt=as.data.frame(dt)

pdf(paste0(evalDir, "/Individual_DotPlots_PerGeneSelection_TCGA.pdf"))
tst= dt %>% dplyr::filter(type=="Top_Positive")
p <- ggplot(tst, aes(x=topGenes, y= Best_Qtl, color= -log10(Pval_Min))) +
  geom_segment( aes(x=topGenes, xend=topGenes, y=0, yend=Best_Qtl)) +
  geom_point( aes(alpha=0.7,  stroke=2, color=-log10(Pval_Min), size= Best_Qtl)) + scale_color_viridis(option="B") + themplot + xlab("Top_PositiveGenes")
print(p)
print(p)
##

tst= dt %>% dplyr::filter(type=="Top_Negative")
g <- ggplot(tst, aes(x=topGenes, y= Best_Qtl, color= -log10(Pval_Min))) +
  geom_segment( aes(x=topGenes, xend=topGenes, y=0, yend=Best_Qtl)) +
  geom_point( aes(alpha=0.7,  stroke=2, color=-log10(Pval_Min), size= Best_Qtl)) + scale_color_viridis(option="B") + themplot + xlab("Top_NegativeGenes")
print(g)
##

tst= dt %>% dplyr::filter(type=="Both_Pos_Neg")

h <- ggplot(tst, aes(x=topGenes, y= Best_Qtl, color= -log10(Pval_Min))) +
  geom_segment( aes(x=topGenes, xend=topGenes, y=0, yend=Best_Qtl)) +
  geom_point( aes(alpha=0.7,  stroke=2, color=-log10(Pval_Min), size= Best_Qtl)) + scale_color_viridis(option="B") + themplot + xlab("Top_Negative_PositiveGenes")
print(h)
dev.off()

##Same plot for all:
pdf(paste0(evalDir, "/DotPlot_All_Qtl_TopNegPosGenes.pdf"))
p <- ggplot(dt, aes(x=topGenes, y= Best_Qtl, color= -log10(Pval_Min), shape= type)) +
  geom_segment( aes(x=topGenes, xend=topGenes, y=0, yend=Best_Qtl)) +
  geom_point( aes(alpha=0.7,  stroke=2, color=-log10(Pval_Min), size= Best_Qtl * 2, shape= type)) + scale_color_viridis(option="B") + themplot + xlab("Top_Negative_PositiveGenes")
print(p)
dev.off()
```

Dot plot for the paper:
```{r}
dt= dt %>% filter(topGenes <= 40)
pdf( paste0(evalDir, "/Lines_AllMerged_AllParams.pdf"))

p <- ggplot(dt, aes(y= -log10(Pval_Min), x= Best_Qtl, color= type , shape= type)) +
  geom_point( aes(  stroke=2, size=topGenes * 10,  shape= type)) +
  themplot + xlab("Bst_Quantile") + scale_color_manual(values= c("Top_Negative"="#2B429E","Top_Positive"="#E0D15C", "Both_Pos_Neg"= "#80E67C")) +  geom_vline(xintercept= seq(0.1, 0.8, 0.1), linetype="dashed", color = "red")
print(p)
dev.off()
```

#-------------- WORK ON THE SIGNATURE---------------------------###
```{r}
gene=intersect(rownames(genexp), toupper(sigP$gene))
mat.exp= genexp[,tn$Sample.ID]
mat.exp=as.data.frame(mat.exp)
#################
gene.comb=combn(gene, 30) %>% t() %>% as.data.frame()

comb_5scores= data.frame("patients"= tn$Sample.ID) %>% t() %>% as.data.frame()
colnames(comb_5scores)= comb_5scores[1,]



for(i in seq_len(nrow(gene.comb))){
  message(paste0("calc for combination nbr=", i))
 comb_5scores[i,]= ScoreSignatures_UCell(matrix= mat.exp,maxRank = 20000 ,features = list("pretumsig"= unname(unlist(gene.comb[i,1:5]))))
}
#---- TEST----- ##
gene.comb30= gene.comb[1:30,]
gene.comb5=combn(gene, 5) %>% t() %>% as.data.frame()
gene.comb5=gene.comb5[1:30,]
qs::qsave(gene.comb,paste0(outputDir2, "/Combination_30genes.qs"))
#------
gene.comb20=combn(gene, 25)
gene.comb5=gene.comb5[1:30,]

gc()
```

Recursive feature elimination:
```{r}
com_RMgenes=data.frame("gene_RM"=NA, "pvalue"=NA)
```

Test feature selection metrics:
```{r}
mat.expr=genexp[which(rownames(genexp) %in% gene), ] %>% as.data.frame()
mat.expr=mat.expr[,tn$Sample.ID]
mat.expr=as.data.frame(t(mat.expr))
tn$stage= tn$Neoplasm.Disease.Stage.American.Joint.Committee.on.Cancer.Code

tn$simplifiedStage= ifelse(tn$stage== "STAGE I"| tn$stage== "STAGE IA", "early","late")
mat.expr$stage=tn$simplifiedStage
```

```{r}
library(caret)
mat.expr$stage = as.factor(mat.expr$stage)
parts = createDataPartition(mat.expr$stage, p = .8, list = F)

train = mat.expr[parts, ]
test = mat.expr[-parts, ]

X_train = train[,-39]
y_train = train[,39]
y_train= as.factor(y_train)
#-----------------
control_rfe = rfeControl(functions = rfFuncs, # random forest
                      method = "repeatedcv", # repeated cv
                      repeats = 5, # number of repeats
                      number = 10) # number of folds
set.seed(50)
# Performing RFE
library(randomForest)
result_rfe = rfe(x = X_train, 
                 y = y_train, 
                 sizes = c(5:15, 20, 25, 30, 35),
                 rfeControl = control_rfe)

# summarising the results
result_rfe #The top 5 variables (out of 35):EMB, IGFBP4, VIM, UBE2C, EMP3

gene.predictors= predictors(result_rfe)
```

```{r}
varimp_data <- data.frame(feature = row.names(varImp(result_rfe)),
                          importance = varImp(result_rfe)[, 1])


g <- ggplot(data = result_rfe, metric = "Accuracy") + theme_bw()
h <- ggplot(data = result_rfe, metric = "Kappa") + theme_bw()

p <- ggplot(data = varimp_data, 
       aes(x = reorder(feature, -importance), y = importance, fill = feature)) +
  geom_bar(stat="identity") + labs(x = "Features", y = "Variable Importance") + 
  geom_text(aes(label = round(importance, 2)), vjust=1, color="black", size=4) + 
  theme_bw() + theme(legend.position = "none") + coord_flip()

pdf(paste0(outputDir2, "VariableImportanceEvaluation_TCGA_TrainingSet.pdf"))
print(p)
print(g)
print(h)
dev.off()

varimp_data$gene=rownames(varimp_data)
writexl::write_xlsx(varimp_data, paste0(outputDir2, "VarImportance_DF.xlsx"))
qs::qsave(result_rfe, paste0(outputDir2, "result_rfe_VarImportance.qs"))
```

```{r}
# Post prediction
postResample(predict(result_rfe, test[,-39]), obs= as.factor(test[,39]))
#Accuracy     Kappa 
#0.8787879 0.0000000 
```

Test with the top 5 or top 15 variables:
```{r}
p16list= list(p16s_5g= c(gene.predictors[1:5]), 
              p16s_6g= c(gene.predictors[1:6]), 
              p16s_7g= c(gene.predictors[1:7]), 
              p16s_8g= c(gene.predictors[1:8]), 
              p16s_9g= c(gene.predictors[1:9]), 
              p16s_10g= c(gene.predictors[1:10]), 
              p16s_11g= gene.predictors[1:11], 
              p16s_12g=gene.predictors[1:12],
              p16s_13g=gene.predictors[1:13],
              p16s_14g=gene.predictors[1:14],
            p16s_15g=gene.predictors[1:15],
            p16s_20g=gene.predictors[1:20],
            p16s_25g=gene.predictors[1:25],
              p16s_30g= gene.predictors[1:30])
             # p16s_35g=gene.predictors[1:35],
            # p16s_38g=gene.predictors[1:38])

library(data.table)
library(UCell)
dg=as.data.frame(mat.exp)
sig.res2= UCell::ScoreSignatures_UCell(matrix = dg, features= p16list, maxRank = 15000)
sig.res2=as.data.frame(sig.res2)
##
identical(rownames(sig.res2), tn$Sample.ID)

sig.res2$stage= mat.expr$stage

qs::qsave(sig.res,paste0(outputDir2, "Signature_P16_AfterFeatureSelection_Basallike_TCGA.qs"))
sig.res= qs::qread(paste0(outputDir2, "Signature_P16_AfterFeatureSelection_Basallike_TCGA.qs"))
```




TEST:

```{r}
bsl= cptac_clin %>% filter(PAM50== "Basal")

bsl$overall_survival= as.numeric(as.character(bsl$overall_survival))
bsl$status= as.numeric(as.character(bsl$status))
##
cptac.dt= ge[, which(colnames(ge) %in% rownames(bsl))]



p16list= list(p16s_5g= c(varimp_data$feature[1:5]), 
              p16s_6g= c(varimp_data$feature[1:6]), 
              p16s_7g= c(varimp_data$feature[1:7]), 
              p16s_8g= c(varimp_data$feature[1:8]), 
              p16s_9g= c(varimp_data$feature[1:9]), 
              p16s_10g= c(varimp_data$feature[1:10]), 
              p16s_11g= varimp_data$feature[1:11], 
              p16s_12g=varimp_data$feature[1:12],
              p16s_13g=varimp_data$feature[1:13],
              p16s_14g=varimp_data$feature[1:14],
            p16s_15g=varimp_data$feature[1:15],
            p16s_20g=varimp_data$feature[1:20],
            p16s_25g=varimp_data$feature[1:25],
              p16s_30g= varimp_data$feature[1:30],
              p16s_35g=varimp_data$feature[1:35],
             p16s_38g=varimp_data$feature[1:38])
library(data.table)
library(UCell)
cptac.dt=as.data.frame(cptac.dt)
sig.resCPTAC= UCell::ScoreSignatures_UCell(matrix = cptac.dt, features= p16list, maxRank = 15000)
sig.resCPTAC=as.data.frame(sig.resCPTAC)
identical(rownames(sig.resCPTAC), rownames(bsl))
sig.resCPTAC=sig.resCPTAC[rownames(bsl),]
sig.resCPTAC$stage= bsl$pathologic_stage
##---------------
sig.resCPTAC= sig.resCPTAC %>% filter(! is.na(sig.resCPTAC$stage))

sig.resCPTAC$stage= ifelse(sig.resCPTAC$stage== "stagei", "early", "late")
qs::qsave(sig.resCPTAC, paste0(outputDir2, "CPTAC_SignaturesAllgenes.qs"))
```

Work on the signatures:
https://stackoverflow.com/questions/27918320/what-does-negative-incmse-in-randomforest-package-mean

```{r}
resTCGA2= data.frame("Ngene"= colnames(sig.res2)[-ncol(sig.res2)], "pvalue"=NA)
sig.res2$stage= factor(sig.res2$stage, levels = c("early", "late"))

for(i in seq_len(ncol(sig.res2)-1)){
  resTCGA2[i,2]= wilcox.test(sig.res2[,i] ~ sig.res2$stage, alternative= "greater")$p.value
}
#---------------------------##
resCPTAC= data.frame("Ngene"= colnames(sig.resCPTAC)[-ncol(sig.resCPTAC)], "pvalue"=NA)

sig.resCPTAC$stage= factor(sig.resCPTAC$stage, levels = c("early", "late"))

for(i in seq_len(ncol(sig.resCPTAC)-1)){
  resCPTAC[i,2]= wilcox.test(sig.resCPTAC[,i] ~ sig.resCPTAC$stage, alternative= "greater")$p.value
}

resCPTAC$nbr= c(seq(5,15), 20, 25, 30, 35, 38)
resTCGA$nbr= c(seq(5,15), 20, 25, 30, 35, 38)

p <- resCPTAC  %>% ggplot(aes(x= nbr, y= pvalue)) + geom_line() + themplot + geom_hline(yintercept = 0.05, color= "red") + geom_vline(xintercept = 13, color="blue") + ggtitle("CPTAC_Pvalue_WilcoxStage")

g <- resTCGA  %>% ggplot(aes(x= nbr, y= pvalue)) + geom_line() + themplot + geom_hline(yintercept = 0.05, color= "red") + geom_vline(xintercept = 13, color="blue") + ggtitle("TCGA_Pvalue_WilcoxStage")

pdf(paste0(outputDir2, "Pvalue_Wilcox_NbrGenes_P16Signature.pdf"))
print(p)
print(g)
dev.off()
```

Test on the CPTACT dataset: DONE ON THE CPTAC WORKBOOK

```{r}
l= list("varimp"= varimp_data, "Pval_CPTAC"= resCPTAC, "Pval_TCGA"= resTCGA)
writexl::write_xlsx(l, paste0(outputDir2, "List_VarianceImportance_CPTAC_TCGA.xlsx"))
```

##--------------------- SURVIVAL TESTS -------------------###
```{r}
#Try with 5 genes only: "EMB"    "IGFBP4" "EMP3"   "VIM"    "UBE2C" 

```

```{r}
identical(tn$Sample.ID, rownames(sig.res))
sig.res$Progress.Free.Survival..Months.=tn$Progress.Free.Survival..Months.

sig.res$Progression.Free.Status_binary=tn$Progression.Free.Status
sig.res$Progression.Free.Status_binary <- ifelse(sig.res$Progression.Free.Status=="0:CENSORED",0,1)

#P16Low should be tn$p16Up < quantile(tn$p16Up, 0.25)
tmpP= data.frame("LengthGenes"= colnames(sig.res)[1:16], "Best_Qtl"= NA, "Pval_Min"=NA) #,1,seq(5, nrow(sigP), 5), nrow(sigP)
rownames(tmpP)= colnames(sig.res)[1:16]
i=0
for(j in seq(1,16)){
  
  qtl=list("quantile"=NA, "hazard"=NA, "waldtest"=NA,"logTestPval"=NA,"waldtestPval"=NA)

for(i in seq(0.1, 0.9, 0.01)){
  sig.res$p16discrete= ifelse(sig.res[,j] > quantile(sig.res[,j], i), 1, 0)
  
   res.cox <- summary(coxph(Surv(Progress.Free.Survival..Months.,Progression.Free.Status_binary ) ~ p16discrete, data = sig.res))
   
  qtl$quantile= append(qtl$quantile, i)
  qtl$hazard=append(qtl$hazard,res.cox$coefficients[,2])
  ##
 qtl$logTestPval= append(qtl$logTestPval, res.cox$logtest[3])
  qtl$waldtest= append(qtl$waldtest,res.cox$waldtest[1] )
   qtl$waldtestPval= append(qtl$waldtestPval,res.cox$waldtest[3] )
} 
  
  
 dt.qtl_binary= do.call(rbind, qtl) %>% t() %>%  as.data.frame()
dt.qtl_binary=dt.qtl_binary[-1,]


bestqtl=  dt.qtl_binary[order( dt.qtl_binary$waldtestPval, decreasing = FALSE),1][1]
bestpval=  dt.qtl_binary[order( dt.qtl_binary$waldtestPval, decreasing = FALSE),5][1]
####
tmpP[j,2]=bestqtl

tmpP[j,3]=bestpval

sig.res$p16discrete= ifelse(sig.res[,j] > quantile(sig.res[,j], bestqtl), "high", "low" )

fit <- survfit(Surv(Progress.Free.Survival..Months.,Progression.Free.Status_binary) ~ p16discrete, data = sig.res)
library(survminer)
pdf(paste0(outputDir2,"SurvivalPlot_TCGA_Signature_Top",tmpP[j,1],"_BestQtl_", bestqtl,"_WaldTest.pdf"), height = 5, width = 5)
 p=ggsurvplot(fit,
          pval = TRUE, conf.int = FALSE,
          risk.table = FALSE, 
          risk.table.col = "strata",
          linetype = "strata", 
          surv.median.line = "hv", 
          ylab="Overall surrival",
          ggtheme = theme_bw(), 
          palette = c("#DED5D5", "#262424", "#756F6F")) 
 print(p)
dev.off()
}

writexl::write_xlsx(tmpP, paste0(outputDir2, "TCGA_RFE_Survival_WaldTest.xlsx"))

#####################
tmpP$LengthGenes= gsub("p16s_", "", tmpP$LengthGenes)
tmpP$LengthGenes=gsub("g_UCell","", tmpP$LengthGenes)

tmpP$LengthGenes=as.numeric(as.character(tmpP$LengthGenes))

pdf(paste0(outputDir2, "Lines_TCGA_BestParams_VarImp_WaldTest.pdf"))
m <- tmpP %>% ggplot(aes(x= LengthGenes, y= Pval_Min,group = 1))  + geom_line() + geom_point()+ themplot + xlab("Top_VarImp_RFE")

n <- tmpP %>% ggplot(aes(x= LengthGenes, y= Best_Qtl,group = 1)) + geom_point() + geom_line() + themplot + xlab("Top_VarImp_RFE")

print(m)
print(n)
dev.off()
```

for the paper:
```{r}
identical(tn$Sample.ID, rownames(sig.res))
sig.res$Progress.Free.Survival..Months.=tn$Progress.Free.Survival..Months.

sig.res$Progression.Free.Status_binary=tn$Progression.Free.Status
sig.res$Progression.Free.Status_binary <- ifelse(sig.res$Progression.Free.Status=="0:CENSORED",0,1)

#P16Low should be tn$p16Up < quantile(tn$p16Up, 0.25)
#tmpP= data.frame("LengthGenes"= colnames(sig.res)[1:16], "Best_Qtl"= NA, "Pval_Min"=NA) #,1,seq(5, nrow(sigP), 5), nrow(sigP)
#rownames(tmpP)= colnames(sig.res)[1:16]
#i=0
#for(j in seq(1,16)){
  
  qtl=list("quantile"=NA, "hazard"=NA, "waldtest"=NA,"logTestPval"=NA,"waldtestPval"=NA)

for(i in seq(0.1, 0.9, 0.01)){
  sig.res$p16discrete= ifelse(sig.res[,9] > quantile(sig.res[,9], i), 1, 0)
  
   res.cox <- summary(coxph(Surv(Progress.Free.Survival..Months.,Progression.Free.Status_binary ) ~ p16discrete, data = sig.res))
   
  qtl$quantile= append(qtl$quantile, i)
  qtl$hazard=append(qtl$hazard,res.cox$coefficients[,2])
  ##
 qtl$logTestPval= append(qtl$logTestPval, res.cox$logtest[3])
  qtl$waldtest= append(qtl$waldtest,res.cox$waldtest[1] )
   qtl$waldtestPval= append(qtl$waldtestPval,res.cox$waldtest[3] )
} 
  
  
 dt.qtl_binary= do.call(rbind, qtl) %>% t() %>%  as.data.frame()
dt.qtl_binary=dt.qtl_binary[-1,]

qs::qsave(dt.qtl_binary, paste0(outputDir2, "/TCGA_Best_Qtl_preHumanSignature_13genes.qs"))



pdf(paste0(outputDir2, "BestQtl_Pvalue_preHuman13gene_WaldTest.pdf"))
m <- dt.qtl_binary %>% ggplot(aes(x= quantile, y= waldtestPval)) + geom_bar(stat="identity") + themplot
print(m)
dev.off()

```


BoxPlot :

```{r}
pdf(paste0(outputDir2, "Boxplot_Top13g_38g_30g.pdf"))
p <- ggplot(data= sig.res, aes(x=stage, y= p16s_13g_UCell)) + geom_boxplot()  + themplot + geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.5) + ggtitle("Important_13genes") 

g <- ggplot(data= sig.res, aes(x=stage, y= p16s_38g_UCell)) + geom_boxplot()  + themplot + geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.5) + ggtitle("Important_38genes")

h <- ggplot(data= sig.res, aes(x=stage, y= p16s_30g_UCell)) + geom_boxplot()  + themplot + geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.5) + ggtitle("Important_30genes")
print(p)
print(h)
print(g)
dev.off()
```

For the paper:
```{r}
varimp_data$i= ifelse(as.numeric(varimp_data$gene) < 14, "Important", "NotImportant")
pdf(paste0(outputDir2, "Barplot_VarImportance_ForPaper.pdf"))
p <- ggplot(data = varimp_data, 
       aes(x = reorder(feature, -importance), y = importance, fill = i)) +
  geom_bar(stat="identity") + labs(x = "Features", y = "Variable Importance")+ 
  themplot + theme(legend.position = "none", axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + scale_fill_manual(values=c("Important"= "black", "NotImportant"="grey"))
print(p)
dev.off()
```
For the paper: Select the optimal quantile:
```{r}

```

