---
title: "Step2_3_Pseudotime_Slingshot_2_PEA"
author: "Melissa"
date: "04/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
mainDir <- here::here() # the MainDir should be the root of Tumor_BRCA_P53:
source(knitr::purl(file.path(mainDir,"Scripts","global_var_current.Rmd"), quiet=TRUE))
source(knitr::purl(file.path(mainDir,"Scripts","scRNAseq_Functions.Rmd"), quiet=TRUE))
source(knitr::purl(file.path(mainDir,"Scripts","global_variables.Rmd"), quiet=TRUE))
```

##---------------- IF YOU ONLY WANT TO CHECK THE FINAL RESULTS, SKIP THESE FIRST STEPS ------------------------#####

```{r}
epith= qs::qread(paste0(RDatadir,"/Epithelial_FinalAnnotation.qs"))
```


Construct Gene modules that are the mostly correlated to  PseudoTime1

```{r}
#take only the most 500 genes:
dat_use <- t(as.matrix(GetAssayData(seu, slot = "data", assay = "RNA"))[head(names(var_imp1), 500),]) #2000
dat_use_df <- cbind(slingPseudotime(sds)[,1], dat_use) 
colnames(dat_use_df)[1] <- "pseudotime"
dat_use_df <- as.data.frame(dat_use_df[!is.na(dat_use_df[,1]),])
####
mcor <- cor(dat_use_df) %>% as.data.frame()
 m <- reshape2::melt(mcor)
m=m %>% dplyr::filter( variable =="pseudotime")
m$gene=colnames(mcor)
m=m %>% dplyr::filter( abs(value) > 0.2)
###
dat_use_cor <- dat_use_df[, which(colnames(dat_use_df) %in% m$gene)]

pdf(paste0(slingshotDir, "/Heatmap_Pairwise_Corr_Pseudotime_Genes.pdf"), width = 10, height = 10)
  pheatmap::pheatmap(cor(dat_use_cor))
dev.off()
```



```{r}
dat_use <- t(as.matrix(GetAssayData(seu, slot = "data", assay = "RNA"))[head(names(var_imp1), 500),])
dat_use_df <- cbind(slingPseudotime(sds)[,1], dat_use) 
colnames(dat_use_df)[1] <- "pseudotime"
dat_use_df <- as.data.frame(dat_use_df[!is.na(dat_use_df[,1]),])
###
dend <- hclust(as.dist(1-cor(dat_use_df)), method="ward.D")
dend = color_branches(dend, k = 5)
dend = color_labels(dend, k = 5)
###
res=dendextend::cutree_1k.dendrogram(dend=dend,k=5) %>% as.data.frame() 
colnames(res)= "GroupID"
stopifnot(all(rownames(res)== rownames(t(dat_use_df))))
md=as.data.frame(t(dat_use_df))
###
md$GroupID= res$GroupID
###
for(i in seq(1: length(unique(res$GroupID)))){
   assign(paste0("s",i), dplyr::filter(md, GroupID==as.character(i)) %>% .[,-ncol(.)] %>% t() %>% as.data.frame())
}
s4$pseudotime=s1$pseudotime
s2$pseudotime=s1$pseudotime
s3$pseudotime=s1$pseudotime
s5$pseudotime=s1$pseudotime
```


```{r}
dat=data.frame()
ds= mget(paste0("s", seq(1:5)))
l=c()
for (i in seq(1:length(ds))){
  enr= enricher(colnames(ds[[i]])[-ncol(ds[[i]])] , TERM2GENE=m_t2g) @result %>% dplyr::filter(., p.adjust< 0.05)%>% .[,c(1,4,6,8)]
  l=append(l, nrow(enr))
  dat=rbind(dat,enr)
}

dat$group= c(rep("s1", l[1]), rep("s2", l[2]), rep("s3", l[3]), rep("s4", l[4]),rep("s5", l[5]))
            # , rep("s5", l[5]))
dat$p.adjust=-log10(dat$p.adjust)
dat$ID=gsub("HALLMARK_","",dat$ID)

qs::qsave(dat, paste0(slingshotDir, "/Slingshot_PEA_Lineage1_Top500genes_CorDist_FinalResults.qs"))
rm( list=paste0("s",seq(1,4)))
writexl::write_xlsx(dat, paste0( slingshotDir, "/Enriched_pathways_geneGroups_alongBranching1_Top500genes.xlsx" ))
```


Construct gene signatures:
```{r}
features=list()
features$ESTROGEN_REPONSE= c(unlist(strsplit(dat$geneID[5], "/")))
features$EMT= c(unlist(strsplit(dat$geneID[c(1,6)], "/")))
features$ANGIOGENESIS= c(unlist(strsplit(dat$geneID[7], "/")))
features$OXPHOS= c(unlist(strsplit(dat$geneID[8], "/")))
features$MITOTIC_SPINDLE= c(unlist(strsplit(dat$geneID[4], "/")))
features$E2F_Targets= c(unlist(strsplit(dat$geneID[2], "/")))
features$G2M_Checkpoint= c(unlist(strsplit(dat$geneID[3], "/")))
#features$APOPTOSIS= c(unlist(strsplit(dat$geneID[10], "/")))
#features$KRAS_SIG= c(unlist(strsplit(dat$geneID[4], "/")))
#features$MTOR_SIG= c(unlist(strsplit(dat$geneID[9], "/")))
### Construct signatures:
epith=UCell::AddModuleScore_UCell(obj = epith, features = features )
seu=UCell::AddModuleScore_UCell(obj = seu, features = features )
##
all(colnames(seu)== rownames(dat_use_df))
seu$pseudotime= dat_use_df$pseudotime
```

```{r}
fn= paste0(names(features),"_UCell")

pdf(paste0(annotDir, "/PEA_UCell_EnrichedPathways_Branch1.pdf"), height = 6, width = 6)
 for (i in seq(1:length(fn))){
   par(mfrow = c(2,1))
  p=FeaturePlot(epith, features = fn[i])+gtheme +theme (axis.text.x = element_text(size=12, face="bold", colour = "black", angle = 30, hjust = 1)) + scale_color_viridis(option="B")
   print(p)
    g=FeaturePlot(seu, features = fn[i])+gtheme +theme (axis.text.x = element_text(size=12, face="bold", colour = "black", angle = 30, hjust = 1)) + scale_color_viridis(option="B")
   print(g)
 }
dev.off()

```


Use c2 signatures and see wether some associated genes with pseudotime 
```{r}
m_t2g <- msigdbr(species = "Mus musculus", category = "C2") %>% dplyr::select(gs_name, gene_symbol) %>% as.data.frame()
###
dat=data.frame()
ds= mget(paste0("s", seq(1:5)))
l=c()
for (i in seq(1:length(ds))){
  enr= enricher(colnames(ds[[i]])[-ncol(ds[[i]])] , TERM2GENE=m_t2g) @result %>% dplyr::filter(., p.adjust< 0.05)%>% .[,c(1,4,6,8)]
  l=append(l, nrow(enr))
  dat=rbind(dat,enr)
}

dat$group= c(rep("s1", l[1]), rep("s2", l[2]), rep("s3", l[3]), rep("s4", l[4]),rep("s5", l[5]))
           # , rep("s5", l[5]))
dat$p.adjust=-log10(dat$p.adjust)

g1 = dat %>% dplyr::filter(ID %in% grep("SENESCENCE", dat$ID, value = T))
g2 = dat %>% dplyr::filter(ID %in% grep("BREAST_CANCER", dat$ID, value = T))
g3 = dat %>% dplyr::filter(ID %in% grep("MAMMARY", dat$ID, value = T))
upc2= rbind(g1, g2, g3)
upc2$term= c(rep("Senescence", nrow(g1)), rep("Breast Cancer", nrow(g2)), rep("Mammary gland", nrow(g3)))
rownames(upc2)=NULL
upc2$geneID= gsub("/", ",", upc2$geneID)
upc2$p.adjust=round(upc2$p.adjust, 2)
###
writexl::write_xlsx(upc2, paste0(slingshotDir, "/MsigDB_C2_filtered_Pseudotime_associatedGenes_pval005.xlsx"))
```


```{r}
qs::qsave(seu, paste0(RDatadir, "/SeuObj_Subset_WithPseudotime.qs"))
```

###---------------------------------START HERE -----------------------------------------------------####
###----------------------- PLOT THE UMAPS/PSEUDOTIME --------------------------------####
```{r}
seu= qs::qread(paste0(RDatadir,"/SeuObj_Subset_WithPseudotime.qs"))
### 
sds= qs::qread(paste0(RDatadir, "/Slingshot_Obj_OnlyTransitioning_ST.qs"))
```


##---------------------Plot PSEUDOTIME VALUES USING SLINGSHOT--------------------------------###
```{r}
####Add the Line to the pseudotime:
dt=as.data.frame(slingCurves(sds)[[1]]$s[slingCurves(sds)[[1]]$ord, ])
colnames(dt)=c("UMAP_1","UMAP_2")
####
umap_custom <- as.data.frame(seu[["umap"]]@cell.embeddings)
umap_custom$pseudotime=seu$pseudotime
draw <- sample(1:dim(umap_custom)[1])
####
png(paste0(slingshotDir,"/SLINGSHOT_NEW_REPRESENTATION.png"),height=1000, width = 1000,res=300)
p <- ggplot(umap_custom[draw,])+ geom_point( aes(x =UMAP_1, y = UMAP_2, fill=pseudotime ),size = 2, shape = 21,alpha=1) + themplot+ NoAxes()+ scale_color_viridis(option="D",limits = c(0.01, 11), na.value= "grey",direction=-1)  + geom_path(data =dt, aes(x=UMAP_1, y=UMAP_2), size = 1, col="black")+ scale_fill_viridis(option="D",limits = c(0.01, 11), na.value= "grey",direction=-1) + NoLegend()
print(p)
dev.off()

##------------------ KEEP IT ------------------------#####
p = FeaturePlot(seu, "pseudotime",  pt.size = 2)  + NoAxes() + ggtitle("") + scale_color_viridis(option="D",limits = c(0.01, 11), na.value= "grey",direction=-1)+NoLegend() #  + geom_path(data =dt, aes(x=UMAP_1, y=UMAP_2), size = 1, col="black") 
p[[1]]$layers[[1]]$aes_params$alpha = 1
#####
pdf(paste0(slingshotDir, "/Umap_Pseudotime_Slingshot_WITH_PATH.pdf"), width = 10, height = 10)
print(p)
dev.off()
```



SCATTER PLOT REPRESENTATION OF THE EVOLUTION OF PATHWAY SCORES ALONG PSEUDOTIME:
```{r}
pathway <- c("ANGIOGENESIS_UCell","EMT_UCell","APOPTOSIS_UCell","ESTROGEN_REPONSE_UCell" )
##
dat <- seu@meta.data[,c("pseudotime", pathway)]
dat$subtype=seu$subtype
##
for (i in seq(2,5)){
    p <- ggplot(dat) + geom_point(aes(x= pseudotime, y= dat[,i], fill=subtype),shape=21,size=2,alpha=1,stroke=0.5)  + ggtitle("") +  geom_smooth(aes(pseudotime,dat[,i] ),method="loess", span=0.3) + scale_fill_manual(values=col[levels(seu)]) +themplot + theme(legend.position="none") + NoAxes()
    
png(paste0(slingshotDir, "/New_Scatter_", pathway[i-1] ,".png"), width = 1200, height = 1200, res = 300)
  print(p)
  dev.off()
}
```


Umap representation the pathway scores
```{r}
##Alternative 1:
dat <- epith@meta.data[,pathway]
umap_coord= as.data.frame(epith[["umap"]]@cell.embeddings)
stopifnot(identical(rownames(umap_coord), rownames(dat)))
dat=cbind(dat, umap_coord)
###

for (i in seq(1,4)){
    p <- ggplot(dat) + geom_point(aes(x= UMAP_1, y= UMAP_2, fill=dat[,i]),shape=21,size=1,alpha=1,stroke=0.5)  + ggtitle("")+ scale_fill_viridis(option="B",limits = c(0, max(dat[,i])), na.value= "grey",direction=-1) +themplot + theme(legend.position="none") + NoAxes()
    
png(paste0(slingshotDir, "/UMAP_epith_Pathways_WOLegend_MainPathways_", pathway[i] ,".png"), width = 1200, height = 1200, res = 300)
  print(p)
  dev.off()
}



###aLTERNATIVE 2:
p<- FeaturePlot(epith, pathway,combine=F, pt.size = 0.75 )
for(i in 1:length(p)) {
  p[[i]] <- p[[i]] + scale_color_viridis(option="B",limits = c(0, 1), na.value= "grey",direction=-1) + NoLegend() + NoAxes() + ggtitle("")
  p[i][[1]]$layers[[1]]$aes_params$alpha = 0.4}
g <-cowplot::plot_grid(plotlist = p, ncol = 4) 

png(paste0(slingshotDir, "/UMAP_epith_Pathways_WOLegend_MainPathways2.png"),width = 4000, height = 1000, res = 300)
print(g)
dev.off()
```

FOR SUPP FIGURE, REPRESENT THE SAME PATHWAY SCORES ON THE SUBSET SEURAT OBJECT:
```{r}
##Alternative 1:
dat <- seu2@meta.data[,pathway]
umap_coord= as.data.frame(seu2[["umap"]]@cell.embeddings)
stopifnot(identical(rownames(umap_coord), rownames(dat)))
dat=cbind(dat, umap_coord)
###

for (i in seq(1,4)){
    p <- ggplot(dat) + geom_point(aes(x= UMAP_1, y= UMAP_2, fill=dat[,i]),shape=21,size=3,alpha=1,stroke=0.5)  + ggtitle("")+ scale_fill_viridis(option="B",limits = c(0, max(dat[,i])), na.value= "grey",direction=-1) +themplot + theme(legend.position="none") + NoAxes()
    
png(paste0(slingshotDir, "/UMAP_SUBSET_Pathways_WOLegend_MainPathways_", pathway[i] ,".png"), width = 1200, height = 1200, res = 300)
  print(p)
  dev.off()
}

```




###------------------ NOT SAVE AS THE CURRENT EPITH CONTAINED ALL THE SIGNALLING PATHWAY SCORES ------------------- ###
save the final epith object with senescence and others:
```{r}
qs::qsave(epith, paste0(RDatadir,"/Epithelial_FinalAnnotation.qs"))
```


